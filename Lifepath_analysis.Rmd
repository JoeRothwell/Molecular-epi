---
title: "Lifepath NMR metabolomics analysis"
output: rmarkdown::github_document
---

```{r setup, include=F}
knitr::opts_chunk$set(echo = TRUE, fig.align = "center")
```

### The Lifepath breast cancer study

The breast cancer case-control is nested within the E3N cohort, a French multicentre prospective study designed to investigate risk factors for cancer and major non-communicable diseases in women. Of 100,000 women followed by the study, 25,000 gave blood samples at baseline. A total of 812 BC cases have since been diagnosed and matched to 812 healthy cases for the case-control.

The following table shows baseline characteristics of participants.

```{r, results = "asis", echo = F, message = F, warning = F}
source("baseline_lifepath.R")
print(st, cnames = c("Controls", "Cases"))
```

### Some background on NMR metabolomics data

NMR measures the spin and magnetic moment properties of the nuclei in a molecule. These properties can be measured in complex mixtures. The sample is radiated with a short pulse of high-energy radio frequencies (typically in the range 100â€“1000 MHz depending on the field strength) that excite all nuclei. When they return to the low-energy state, they emit a pattern of frequencies representing the different energy emissions from the different nuclei. An NMR spectrum is generated as the ppm value, or chemical shift, against intensity. Chemical shift is measured in parts per million (ppm) of the radiation frequency emitted. The more shielded a nucleus is, the higher the chemical shift.

### Exploratory analysis

Read in metabolomics data from text file. There are 44 compounds measured for 1623 subjects, and subject identifiers in the first column, `CODBMB`.

```{r message = F, warning = F}
library(tidyverse)
ints <- read_tsv("1507_XMetabolite_std_cpmg_E3N.txt")
dim(ints)
colnames(ints)
```

The metabolomics data are previewed as follows:

```{r message = F, warning = F, results = "asis"}
knitr::kable(ints[1:5, 1:10], caption = "Preview of the metabolomics data.", format = "html")
```

Intensity data are both positive and negative and most values in between -2 and 2. Data appear to be scaled and centered.
We can plot the total intensity of each metabolite, being sure first to remove the ID column:

```{r totalint, message = F, warning  = F}
plot(colSums(ints[ , -1]), xlab = "Compound number", ylab = "Scaled intensity",
     pch = 19, col = "dodgerblue", main = "Summed intensities of 44 metabolites", font.main = 1)
```

_Summed intensities of 44 serum metabolites measured by NMR._

Total intensities are similar between compounds and normally distributed.We can now look at correlations between compounds:

```{r corr, message = F, warning = F}
cormat <- cor(ints)
colnames(cormat) <- NULL
library(corrplot)
corrplot(cormat, method = "square", tl.col = "black", tl.cex = 0.8)
```

_Inter-compound correlations._

Of note is that the three fatty acid variables are correlated, as well as valine and leucine and NAC1 and NAC2.
Next we can plot a PCA of the compound profiles:

```{r pca, message = F, warning = F, fig.width=6, fig.height=6, fig.align="center"}
ints <- ints[ , -1]
pca <- prcomp(ints, scale.=F)
library(pca3d)
pca2d(pca)
title("Metabolite profiles of 1623 subjects", font.main = 1)
box(which = "plot", lty = "solid")
```

_Scores plot of metabolic profiles of 1623 subjects in the Lifepath study._

There are no obvious batch effects or patterns in the data.

There is one notable outlying profile in the bottom right-hand corner of the plot. This could be caused by a technical issue with the sample. We can find the identity of this, remove it from the dataset and rerun the PCA. The biplot shows us the variables loading most strongly onto PC1 and PC2.

```{r outlier-removal, message=F, warning=F, fig.height=6, fig.width=6}
which(pca$x[, 2] < -10)
pca1 <- prcomp(ints[-1409, -1], scale.=F)
pca2d(pca1, biplot = T)
title("Metabolite profiles of 1623 subjects with loadings", font.main = 1)
box(which = "plot", lty = "solid")
```

_Biplot of metabolic profiles in the Lifepath study (n = 1622)._

PC1 is characterised by relative concentrations of fatty acid, lysine and ornithine. PC2 is characterised by relative concentrations of creatinine, isoleucine and glycerophosphocholine.

### PCPR2 analysis to find sources of variation in data

The following variables have been hypothesised to contribute to variation in metabolomics data: week of NMR analysis, collection centre, age, BMI, menopausal status, smoking status, diabetic status, fasting status, time before centrifugation, storage time, year of collection. PCPR2 was therefore performed on this set of Y-variables and the X-matrix of NMR intensity values.

```{r pcpr2, echo=F, warning=F, message=F, results=F}
source("PCPR2_lifepath_vec.R")
print(bp)
```

Of the variables included, centre of blood collection (PLACE) contributed most to variation in metabolomics data.

### Risk models for lifestyle variables and serum metabolite concentrations

BC case-control status was modelled by the non-matching factors BMI, smoking status and diabetes status.

```{r clr-model, echo = F, message = F, warning = F, fig.width=8, fig.height=3}
meta1 <- meta %>%
  select(CODBMB, CT, MATCH, WEEKS, PLACE, AGE, BMI, MENOPAUSE, FASTING, SMK, DIABETE, CENTTIMECat1, SAMPYEAR, STOCKTIME) %>%
  mutate_at(vars(-CODBMB, -CT, -AGE, -BMI, -WEEKS, -STOCKTIME), as.factor)

# Conditional logistic regression to get odds ratios for lifestyle factors
library(survival)
fit <- clogit(CT ~ BMI + SMK + DIABETE + strata(MATCH), data = meta1) 
library(broom)
t1 <- tidy(fit) %>% select(-(std.error:p.value))

library(metafor)
par(mar=c(5,4,1,2))
forest(t1$estimate, ci.lb = t1$conf.low, ci.ub = t1$conf.high, refline = 1, 
       xlab = "Multivariable adjusted odds ratio",
       transf = exp, pch = 18, psize = 1.5, slab = t1$term, alim = c(0,2), xlim = c(-1, 3))
text(-1, 5, "Variable", pos = 4)
text(3, 5, "OR [95% CI]", pos = 2)
```

None of BMI, smoking status or diabetes status were significantly associated with BC.

The 44 metabolites were then added to the model, adjusting for BMI, smoking status and diabetes status.


```{r clr2-model, echo = F, message = F, warning = F, fig.width=8, fig.height=10}
ints <- read_tsv("1507_XMetabolite_std_cpmg_E3N.txt")
# CLR models to get odds ratios for metabolites
data <- left_join(meta1, ints, by = "CODBMB")
clr <- function(x) clogit(CT ~ x + BMI + SMK + DIABETE + strata(MATCH), data = meta1)
multifit <- apply(data[, 15:ncol(data)], 2, clr)
t2 <- map_df(multifit, tidy) %>% filter(term == "x")

par(mar=c(5,4,1,2))
forest(t2$estimate, ci.lb = t2$conf.low, ci.ub = t2$conf.high, refline = 1,
       xlab = "Multivariable adjusted odds ratio",
       transf = exp, pch = 18, psize = 1, slab = names(multifit))
hh <- par("usr")
text(hh[1], nrow(t2) + 2, "Parameter", pos = 4)
text(hh[2], nrow(t2) + 2, "OR [95% CI]", pos = 2)
```

Hypoxanthine and inosine concentrations were associated with increased risk of BC. NAC1 and NAC2 were borderline associated with with increased risk of BC.